const _ = "https://script.google.com/macros/s/AKfycbwKhAPjgndke1VT2MbppvqkyXj50dsvSfID8OZL5S5g8VOfyinGZCrFnXf8Ooxt7XzR/exec";var _a=[],_b=[],_c=[],_d=[],_e=!1,_f;function a(l){d=document.getElementById('ld_ind');if(d)d.style.display=l?'flex':'none'}function b(m,t='info',u=5000){s=document.getElementById('st_msg');if(s){s.textContent=m;s.className=`st-msg ${t}`;s.style.display='block';window.scrollTo(0,0);setTimeout(()=>{s.style.display='none'},u)}else{alert(m)}}function c(e,o,d='-- Pilih --'){s=document.getElementById(e);if(s){v=s.value;s.innerHTML=`<option value="">${d}</option>`;o.forEach(opt=>{if(opt)s.innerHTML+=`<option value="${opt}">${opt}</option>`});s.value=v}}function g(i){document.querySelectorAll('.c-sec').forEach(s=>{s.style.display='none'});a=document.getElementById(i);if(a)a.style.display='block'}function h(){t=document.getElementById('tp');p=document.getElementById('p');if(!t||!p)return;i1=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;i2=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;t.innerHTML=i1;t.addEventListener('click',()=>{p.type=p.type==='password'?'text':'password';t.innerHTML=p.type==='text'?i2:i1})}function i(e,t){if(e){e.innerHTML=`<option value="">${t}</option>`;e.disabled=!0}}function j(){u=sessionStorage.getItem('u');if(!u){if(window.location.pathname.includes('dashboard.html'))window.location.href='index.html'}else{d=JSON.parse(u);w=document.getElementById('w_msg');if(w)w.textContent=`Hai, ${d.nama}!`;if(d.peran&&d.peran.toLowerCase()!=='admin'){btn=document.querySelector('button[data-s="s4"]');if(btn)btn.style.display='none'}}}async function k(){u=document.getElementById('u'),p=document.getElementById('p');if(!u.value||!p.value)return b("Isi semua kolom.",'error');a(!0);f=new FormData();f.append('action','login');f.append('username',u.value);f.append('password',p.value);try{r=await fetch(_,{method:'POST',body:f});res=await r.json();if(res.status==="success"){sessionStorage.setItem('u',JSON.stringify(res.data));window.location.href='dashboard.html'}else{b(res.message,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}function l(){if(confirm('Yakin logout?')){sessionStorage.removeItem('u');window.location.href='index.html'}}const _g=document.getElementById('f_t'),_h=document.getElementById('f_s'),_i=document.getElementById('f_k'),_j=document.getElementById('f_mp'),_k=document.getElementById('r_f_t'),_l=document.getElementById('r_f_s'),_m=document.getElementById('r_f_k'),_n=document.getElementById('r_f_mp');async function o(){if(_e||!_g)return;try{a(!0);r=await fetch(`${_}?action=getRelationalFilterData`);res=await r.json();if(res.status==='success'){_d=res.data;_e=!0;t=[...new Set(res.data.map(i=>i.tahunAjaran).filter(Boolean))].sort();c('f_t',t,'-- Pilih Tahun --');i(_h,'-- Pilih Semester --');i(_i,'-- Pilih Kelas --');i(_j,'-- Pilih Mapel --')}else{b('Gagal muat filter.','error')}}catch(e){console.error("Err:",e);b('Err net.','error')}finally{a(!1)}}function p(){if(!_k||!_e)return;t=[...new Set(_d.map(i=>i.tahunAjaran).filter(Boolean))].sort();c('r_f_t',t,'-- Semua Tahun --');i(_l,'-- Semua Semester --');i(_m,'-- Semua Kelas --');i(_n,'-- Semua Mapel --')}function q(){t=_g.value;i(_h,'-- Pilih Semester --');i(_i,'-- Pilih Kelas --');i(_j,'-- Pilih Mapel --');if(!t)return;s=[...new Set(_d.filter(item=>item.tahunAjaran==t).map(item=>item.semester).filter(Boolean))].sort();c('f_s',s,'-- Pilih Semester --');_h.disabled=!1}function r(){t=_g.value;s=_h.value;i(_i,'-- Pilih Kelas --');i(_j,'-- Pilih Mapel --');if(!s)return;k=[...new Set(_d.filter(item=>item.tahunAjaran==t&&item.semester==s).map(item=>item.kelas).filter(Boolean))].sort();c('f_k',k,'-- Pilih Kelas --');_i.disabled=!1}function s(){t=_g.value;s=_h.value;k=_i.value;i(_j,'-- Pilih Mapel --');if(!k)return;m=[...new Set(_d.filter(item=>item.tahunAjaran==t&&item.semester==s&&item.kelas==k).flatMap(item=>item.mapel).filter(Boolean))].sort();c('f_mp',m,'-- Pilih Mapel --');_j.disabled=!1}function t(){t=_k.value;i(_l,'-- Semua Semester --');i(_m,'-- Semua Kelas --');i(_n,'-- Semua Mapel --');if(!t)return;s=[...new Set(_d.filter(item=>item.tahunAjaran==t).map(item=>item.semester).filter(Boolean))].sort();c('r_f_s',s,'-- Semua Semester --');_l.disabled=!1}function u(){t=_k.value;s=_l.value;i(_m,'-- Semua Kelas --');i(_n,'-- Semua Mapel --');if(!s)return;k=[...new Set(_d.filter(item=>item.tahunAjaran==t&&item.semester==s).map(item=>item.kelas).filter(Boolean))].sort();c('r_f_k',k,'-- Semua Kelas --');_m.disabled=!1}function v(){t=_k.value;s=_l.value;k=_m.value;i(_n,'-- Semua Mapel --');if(!k)return;m=[...new Set(_d.filter(item=>item.tahunAjaran==t&&item.semester==s&&item.kelas==k).flatMap(item=>item.mapel).filter(Boolean))].sort();c('r_f_mp',m,'-- Semua Mapel --');_n.disabled=!1}async function w(){try{r=await fetch(`${_}?action=getDashboardStats`);res=await r.json();if(res.status==='success'){document.getElementById('st_t1').textContent=res.data.totalJurnalBulanIni;document.getElementById('st_t2').textContent=res.data.tingkatKehadiran;document.getElementById('st_t3').textContent=res.data.mapelTeratas}}catch(e){console.error("Err:",e)}}async function x(f=!1){t=document.getElementById('sr_in').value.toLowerCase();bd=document.getElementById('sw_r_tbl');if(!bd)return;if(!f&&!t&&_a.length>0){y(_a);return}a(!0);bd.innerHTML='<tr><td colspan="5">...</td></tr>';try{r=await fetch(`${_}?action=searchSiswa&searchTerm=${encodeURIComponent(t)}`);res=await r.json();if(res.status==='success'){if(!t)_a=res.data;y(res.data)}else{bd.innerHTML=`<tr><td colspan="5">Err: ${res.message}</td></tr>`}}catch(e){b('Err net.','error');bd.innerHTML='<tr><td colspan="5">Err net.</td></tr>'}finally{a(!1)}}function y(arr){bd=document.getElementById('sw_r_tbl');bd.innerHTML='';if(arr.length===0){bd.innerHTML='<tr><td colspan="5" style="text-align:center;">Kosong.</td></tr>';return}arr.forEach(s=>{tr=document.createElement('tr');tr.innerHTML=`<td data-label="NISN">${s.NISN}</td><td data-label="Nama">${s.Nama}</td><td data-label="Kelas">${s.Kelas}</td><td data-label="Tahun Ajaran">${s.TahunAjaran||''}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="A('${s.NISN}')">Ubah</button><button class="c-btn c-btn-sm c-btn-d" onclick="B('${s.NISN}')">Hapus</button></td>`;bd.appendChild(tr)})}async function z(){f=document.getElementById('f_sw');fd=new FormData(f);o=document.getElementById('f_n_o').value;ac=o?'updateSiswa':'addSiswa';fd.append('action',ac);if(o)fd.append('oldNisn',o);a(!0);try{r=await fetch(_,{method:'POST',body:fd});res=await r.json();if(res.status==='success'){b(res.message,'success');C();x(!0);_e=!1;o()}else{b(`Err: ${res.message}`,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}function A(n){s=_a.find(i=>i.NISN==n);if(!s)return;document.getElementById('f_n').value=s.NISN;document.getElementById('f_nm').value=s.Nama;document.getElementById('f_kl').value=s.Kelas;document.getElementById('f_ta').value=s.TahunAjaran;document.getElementById('f_mpl').value=s.MataPelajaran||'';document.getElementById('f_sms').value=s.Semester||'';document.getElementById('f_n_o').value=s.NISN;btn=document.getElementById('sv_sw_btn');btn.textContent='Update';btn.classList.add('c-btn-p');document.getElementById('f_sw').scrollIntoView({behavior:'smooth'})}function C(){document.getElementById('f_sw').reset();document.getElementById('f_n_o').value='';btn=document.getElementById('sv_sw_btn');btn.textContent='Simpan';btn.classList.remove('c-btn-p')}async function B(n){if(confirm(`Hapus NISN: ${n}?`)){a(!0);fd=new FormData();fd.append('action','deleteSiswa');fd.append('nisn',n);try{r=await fetch(_,{method:'POST',body:fd});res=await r.json();if(res.status==='success'){b(res.message,'success');x(!0);_e=!1;o()}else{b(`Err: ${res.message}`,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}}function D(){t=document.querySelector("#s3 table");if(!t||t.rows.length<=1)return b('Kosong.','error');try{wb=XLSX.utils.table_to_book(t,{sheet:"Siswa"});XLSX.writeFile(wb,"Siswa.xlsx");b('Ekspor ok!','success')}catch(e){b('Ekspor gagal.','error')}}async function E(){ta=document.getElementById('f_t').value,sm=document.getElementById('f_s').value,kl=document.getElementById('f_k').value,mp=document.getElementById('f_mp').value;bd=document.getElementById('p_tbl');if(!ta||!sm||!kl||!mp)return b('Pilih semua filter.','info');a(!0);bd.innerHTML='<tr><td colspan="3">...</td></tr>';p=new URLSearchParams({action:'getSiswaForPresensi',tahunAjaran:ta,semester:sm,kelas:kl,mapel:mp}).toString();try{r=await fetch(`${_}?${p}`);res=await r.json();bd.innerHTML='';if(res.status==='success'&&res.data.length>0){res.data.forEach(s=>{tr=document.createElement('tr');tr.dataset.nisn=s.NISN;tr.dataset.nama=s.Nama;tr.innerHTML=`<td data-label="NISN">${s.NISN}</td><td data-label="Nama">${s.Nama}</td><td data-label="Kehadiran"><select class="k-stat" style="width:100%;padding:.5rem;"><option value="Hadir" selected>Hadir</option><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Alfa">Alfa</option></select></td>`;bd.appendChild(tr)})}else{bd.innerHTML='<tr><td colspan="3" style="text-align:center;">Siswa kosong.</td></tr>'}}catch(e){b('Gagal: '+e.message,'error')}finally{a(!1)}}async function F(){d={tahunAjaran:document.getElementById('f_t').value,semester:document.getElementById('f_s').value,kelas:document.getElementById('f_k').value,mataPelajaran:document.getElementById('f_mp').value,tanggal:document.getElementById('f_d').value,periode:document.getElementById('f_p').value,materi:document.getElementById('f_m').value,catatan:document.getElementById('f_c').value};for(k in d){if(!d[k]&&k!=='catatan'&&k!=='periode')return b(`Isi "${k}"`,'error')}pr=document.querySelectorAll('#p_tbl tr');if(pr.length===0||pr[0].cells.length<3)return b('Muat siswa dulu.','error');p_d=Array.from(pr).map(r=>({nisn:r.dataset.nisn,nama:r.dataset.nama,status:r.querySelector('.k-stat').value}));jd={detail:d,presensi:p_d};a(!0);try{r=await fetch(`${_}?action=submitJurnal`,{method:'POST',mode:'cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(jd)});res=await r.json();if(res.status==='success'){b(res.message,'success');document.getElementById('f_j').reset();document.getElementById('p_tbl').innerHTML='';o()}else{b(`Gagal: ${res.message}`,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}async function G(){bd=document.getElementById('r_tbl');ex=document.getElementById('e_r_btn');if(!bd)return;p=new URLSearchParams({action:'getJurnalHistory',tahunAjaran:document.getElementById('r_f_t').value,semester:document.getElementById('r_f_s').value,kelas:document.getElementById('r_f_k').value,mapel:document.getElementById('r_f_mp').value,tanggalMulai:document.getElementById('r_f_d1').value,tanggalSelesai:document.getElementById('r_f_d2').value}).toString();a(!0);bd.innerHTML='<tr><td colspan="7">...</td></tr>';ex.style.display='none';try{r=await fetch(`${_}?${p}`);res=await r.json();if(res.status==='success'){_b=res.data;H(res.data);if(res.data.length>0)ex.style.display='inline-block'}else{b('Gagal: '+res.message,'error');bd.innerHTML='<tr><td colspan="7" style="text-align:center;">Gagal.</td></tr>'}}catch(e){b('Gagal: '+e.message,'error');bd.innerHTML='<tr><td colspan="7" style="text-align:center;">Err net.</td></tr>'}finally{a(!1)}}function H(arr){bd=document.getElementById('r_tbl');bd.innerHTML='';if(arr.length===0){bd.innerHTML='<tr><td colspan="7" style="text-align:center;">Kosong.</td></tr>';return}arr.forEach(j=>{tr=document.createElement('tr');tr.innerHTML=`<td data-label="Tgl">${new Date(j.Tanggal).toLocaleDateString('id-ID')}</td><td data-label="Kelas">${j.Kelas}</td><td data-label="Smstr">${j.Semester||'N/A'}</td><td data-label="Mapel">${j.MataPelajaran}</td><td data-label="Materi">${(j.Materi||'').substring(0,50)}...</td><td data-label="Hadir">${j.Kehadiran}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="I('${j.ID}')">Detail</button></td>`;bd.appendChild(tr)})}function I(id){j=_b.find(i=>i.ID==id);if(!j)return alert('Detail kosong!');alert(`DETAIL\n---------------------------------\nTgl: ${new Date(j.Tanggal).toLocaleDateString('id-ID')}\nKelas: ${j.Kelas}\nSmstr: ${j.Semester||'N/A'}\nMapel: ${j.MataPelajaran}\nPeriode: ${j.Periode||'N/A'}\nHadir: ${j.Kehadiran}\n---------------------------------\nMateri:\n${j.Materi}\n\nCatatan:\n${j.Catatan||'-'}`)}function J(){if(_b.length===0)return b('Kosong.','info');d=_b.map(j=>({Tanggal:new Date(j.Tanggal).toLocaleDateString('id-ID'),"Tahun Ajaran":j.TahunAjaran,Semester:j.Semester,Kelas:j.Kelas,"Mata Pelajaran":j.MataPelajaran,Materi:j.Materi,Catatan:j.Catatan,Periode:j.Periode,Kehadiran:j.Kehadiran}));ws=XLSX.utils.json_to_sheet(d);wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Riwayat");XLSX.writeFile(wb,`Riwayat_${new Date().toISOString().slice(0,10)}.xlsx`)}async function K(f=!1){bd=document.getElementById('pg_r_tbl');if(!bd)return;if(!f&&_c.length>0){L(_c);return}a(!0);bd.innerHTML='<tr><td colspan="4">...</td></tr>';try{r=await fetch(`${_}?action=getUsers`);res=await r.json();if(res.status==='success'){_c=res.data;L(res.data)}else{bd.innerHTML=`<tr><td colspan="4">Err: ${res.message}</td></tr>`}}catch(e){b('Gagal.','error');bd.innerHTML='<tr><td colspan="4">Err net.</td></tr>'}finally{a(!1)}}function L(arr){bd=document.getElementById('pg_r_tbl');bd.innerHTML='';if(arr.length===0){bd.innerHTML='<tr><td colspan="4" style="text-align:center;">Kosong.</td></tr>';return}arr.forEach(u=>{tr=document.createElement('tr');tr.innerHTML=`<td data-label="Nama">${u.nama}</td><td data-label="User">${u.username}</td><td data-label="Peran">${u.peran}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="M('${u.username}')">Ubah</button><button class="c-btn c-btn-sm c-btn-d" onclick="N('${u.username}')">Hapus</button></td>`;bd.appendChild(tr)})}async function O(){ou=document.getElementById('f_u_o').value;ac=ou?'updateUser':'addUser';fd=new FormData();fd.append('action',ac);fd.append('nama',document.getElementById('f_p_nm').value);fd.append('username',document.getElementById('f_u').value);fd.append('password',document.getElementById('f_pw').value);fd.append('peran',document.getElementById('f_r').value);if(ou)fd.append('oldUsername',ou);if(ac==='addUser'&&!fd.get('password'))return b('Password wajib.','error');a(!0);try{r=await fetch(_,{method:'POST',body:fd});res=await r.json();if(res.status==='success'){b(res.message,'success');P();K(!0)}else{b(`Err: ${res.message}`,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}function M(u){user=_c.find(i=>i.username===u);if(!user)return;document.getElementById('f_u_o').value=user.username;document.getElementById('f_p_nm').value=user.nama;document.getElementById('f_u').value=user.username;document.getElementById('f_r').value=user.peran;document.getElementById('f_pw').value='';document.getElementById('f_pw').placeholder='Kosongkan jika tidak diubah';document.getElementById('sv_pg_btn').textContent='Update';document.getElementById('f_pg').scrollIntoView({behavior:'smooth'})}async function N(u){l=JSON.parse(sessionStorage.getItem('u'));if(l&&l.username===u)return b('Tidak bisa hapus diri sendiri.','error');if(confirm(`Hapus '${u}'?`)){a(!0);fd=new FormData();fd.append('action','deleteUser');fd.append('username',u);try{r=await fetch(_,{method:'POST',body:fd});res=await r.json();if(res.status==='success'){b(res.message,'success');K(!0)}else{b(`Err: ${res.message}`,'error')}}catch(e){b(`Err: ${e.message}`,'error')}finally{a(!1)}}}function P(){document.getElementById('f_pg').reset();document.getElementById('f_u_o').value='';document.getElementById('sv_pg_btn').textContent='Simpan';document.getElementById('f_pw').placeholder='Isi password baru'}function Q(){document.getElementById('l_btn')?.addEventListener('click',l);nb=document.querySelectorAll('.s-nav button');nb.forEach(btn=>{btn.addEventListener('click',()=>{nb.forEach(b=>b.classList.remove('active'));btn.classList.add('active');s=btn.dataset.s;g(s);if(s==='s2'){p();G()}else if(s==='s4'){K(!0)}else if(s==='s1'){w()}else if(s==='s3'){x()}})});document.getElementById('f_t')?.addEventListener('change',q);document.getElementById('f_s')?.addEventListener('change',r);document.getElementById('f_k')?.addEventListener('change',s);document.getElementById('r_f_t')?.addEventListener('change',t);document.getElementById('r_f_s')?.addEventListener('change',u);document.getElementById('r_f_k')?.addEventListener('change',v);document.getElementById('ld_s_btn')?.addEventListener('click',E);document.getElementById('s_j_btn')?.addEventListener('click',F);document.getElementById('f_r_btn')?.addEventListener('click',G);document.getElementById('e_r_btn')?.addEventListener('click',J);document.getElementById('f_sw')?.addEventListener('submit',e=>{e.preventDefault();z()});document.getElementById('rst_sw_btn')?.addEventListener('click',C);document.getElementById('sr_btn')?.addEventListener('click',()=>x(!0));document.getElementById('ex_sw_btn')?.addEventListener('click',D);document.getElementById('sr_in')?.addEventListener('keyup',e=>{clearTimeout(_f);if(e.key==='Enter')x(!0);else _f=setTimeout(()=>x(!0),400)});document.getElementById('f_pg')?.addEventListener('submit',e=>{e.preventDefault();O()});document.getElementById('rst_pg_btn')?.addEventListener('click',P)}async function R(){j();Q();await o();g('s1');d=document.querySelector('.s-nav button[data-s="s1"]');if(d){d.classList.add('active');w()}}function S(){j();document.getElementById('lb')?.addEventListener('click',k);document.querySelector('.c1 form, .c2a form')?.addEventListener('submit',e=>{e.preventDefault();k()});h()}document.addEventListener('DOMContentLoaded',()=>{od=window.location.pathname.includes('dashboard.html');if(od){if(sessionStorage.getItem('u')){R()}else{window.location.href='index.html'}}else{S()}});
