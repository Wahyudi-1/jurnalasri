const _A="https://script.google.com/macros/s/AKfycby-tvNoDtkx3jID_oqWDItDVWRfQwhVPl0ByWqdD3LX6z2Rp8FuvcexZ1NrWdLMI6dLMw/exec";let _B=[],_C=[],_D=[],_E=[],_F=!1,_G;const I=document.getElementById.bind(document),_H=d=>I('ld_ind').style.display=d?'flex':'none',_I=(m,t='info',d=5e3)=>{const s=I('st_msg');s&&(s.textContent=m,s.className=`st-msg ${t}`,s.style.display='block',window.scrollTo(0,0),setTimeout(()=>s.style.display='none',d))||alert(m)},_J=(e,o,d='-- Pilih --')=>{const s=I(e);if(s){const c=s.value;s.innerHTML=`<option value="">${d}</option>`,o.forEach(p=>p&&(s.innerHTML+=`<option value="${p}">${p}</option>`)),s.value=c}},_K=s=>{document.querySelectorAll('.c-sec').forEach(e=>e.style.display='none');const a=I(s);a&&(a.style.display='block')},_L=()=>{const t=I('tp'),p=I('p');if(!t||!p)return;const e=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,s=`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;t.innerHTML=e,t.addEventListener('click',()=>{p.type=p.type==='password'?(t.innerHTML=s,'text'):(t.innerHTML=e,'password')})},_M=(s,d)=>{s&&(s.innerHTML=`<option value="">${d}</option>`,s.disabled=!0)};const _N=()=>{const u=sessionStorage.getItem('loggedInUser');if(!u)window.location.pathname.includes('dashboard.html')&&(window.location.href='index.html');else{const d=JSON.parse(u),w=I('w_msg');w&&(w.textContent=`Hai, ${d.nama}!`),d.peran&&d.peran.toLowerCase()!=='admin'&&(I('s4').style.display='none')}},_O=async()=>{const u=I('u'),p=I('p');if(!u.value||!p.value)return _I("Username/password wajib diisi.",'error');_H(!0);const f=new FormData;f.append('action','login'),f.append('username',u.value),f.append('password',p.value);try{const r=await fetch(_A,{method:'POST',body:f}),t=await r.json();"success"===t.status?(sessionStorage.setItem('loggedInUser',JSON.stringify(t.data)),window.location.href='dashboard.html'):_I(t.message,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}},_P=()=>{confirm('Yakin ingin logout?')&&(sessionStorage.removeItem('loggedInUser'),window.location.href='index.html')};const _Q=I('f_t'),_R=I('f_s'),_S=I('f_k'),_T=I('f_mp'),_U=I('r_f_t'),_V=I('r_f_s'),_W=I('r_f_k'),_X=I('r_f_mp');const _Y=async()=>{if(_F||!_Q)return;try{_H(!0);const r=await fetch(`${_A}?action=getRelationalFilterData`),t=await r.json();if('success'===t.status){_E=t.data,_F=!0;const a=[...new Set(t.data.map(i=>i.tahunAjaran).filter(Boolean))].sort();_J('f_t',a,'-- Pilih Tahun --'),_M(_R,'-- Pilih Semester --'),_M(_S,'-- Pilih Kelas --'),_M(_T,'-- Pilih Mapel --')}else _I('Gagal memuat filter.','error')}catch(e){console.error("Gagal load filter:",e),_I('Error jaringan.','error')}finally{_H(!1)}},_Z=()=>{if(!_U||!_F)return;const a=[...new Set(_E.map(i=>i.tahunAjaran).filter(Boolean))].sort();_J('r_f_t',a,'-- Semua Tahun --'),_M(_V,'-- Semua Semester --'),_M(_W,'-- Semua Kelas --'),_M(_X,'-- Semua Mapel --')},_a=()=>{const t=_Q.value;_M(_R,'-- Pilih Semester --'),_M(_S,'-- Pilih Kelas --'),_M(_T,'-- Pilih Mapel --');if(!t)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t).map(i=>i.semester).filter(Boolean))].sort();_J('f_s',a,'-- Pilih Semester --'),_R.disabled=!1},_b=()=>{const t=_Q.value,s=_R.value;_M(_S,'-- Pilih Kelas --'),_M(_T,'-- Pilih Mapel --');if(!s)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t&&i.semester==s).map(i=>i.kelas).filter(Boolean))].sort();_J('f_k',a,'-- Pilih Kelas --'),_S.disabled=!1},_c=()=>{const t=_Q.value,s=_R.value,k=_S.value;_M(_T,'-- Pilih Mapel --');if(!k)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t&&i.semester==s&&i.kelas==k).flatMap(i=>i.mapel).filter(Boolean))].sort();_J('f_mp',a,'-- Pilih Mapel --'),_T.disabled=!1},_d=()=>{const t=_U.value;_M(_V,'-- Semua Semester --'),_M(_W,'-- Semua Kelas --'),_M(_X,'-- Semua Mapel --');if(!t)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t).map(i=>i.semester).filter(Boolean))].sort();_J('r_f_s',a,'-- Semua Semester --'),_V.disabled=!1},_e=()=>{const t=_U.value,s=_V.value;_M(_W,'-- Semua Kelas --'),_M(_X,'-- Semua Mapel --');if(!s)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t&&i.semester==s).map(i=>i.kelas).filter(Boolean))].sort();_J('r_f_k',a,'-- Semua Kelas --'),_W.disabled=!1},_f=()=>{const t=_U.value,s=_V.value,k=_W.value;_M(_X,'-- Semua Mapel --');if(!k)return;const a=[...new Set(_E.filter(i=>i.tahunAjaran==t&&i.semester==s&&i.kelas==k).flatMap(i=>i.mapel).filter(Boolean))].sort();_J('r_f_mp',a,'-- Semua Mapel --'),_X.disabled=!1},_g=async()=>{try{const r=await fetch(`${_A}?action=getDashboardStats`),t=await r.json();'success'===t.status&&(I('st_t1').textContent=t.data.totalJurnalBulanIni,I('st_t2').textContent=t.data.tingkatKehadiran,I('st_t3').textContent=t.data.mapelTeratas)}catch(e){console.error("Gagal stat:",e)}},_h=async f=>{const t=I('sr_in').value.toLowerCase(),b=I('sw_r_tbl');if(!b)return;if(!f&&!t&&_B.length>0)return _i(_B);_H(!0),b.innerHTML='<tr><td colspan="5">Mencari...</td></tr>';try{const r=await fetch(`${_A}?action=searchSiswa&searchTerm=${encodeURIComponent(t)}`),s=await r.json();'success'===s.status?(!t&&(_B=s.data),_i(s.data)):b.innerHTML=`<tr><td colspan="5">Gagal: ${s.message}</td></tr>`}catch(e){_I('Error cari siswa.','error'),b.innerHTML='<tr><td colspan="5">Error server.</td></tr>'}finally{_H(!1)}},_i=a=>{const b=I('sw_r_tbl');b.innerHTML='',a.length===0?b.innerHTML='<tr><td colspan="5" style="text-align:center;">Data tidak ditemukan.</td></tr>':a.forEach(s=>{const r=document.createElement('tr');r.innerHTML=`<td data-label="NISN">${s.NISN}</td><td data-label="Nama">${s.Nama}</td><td data-label="Kelas">${s.Kelas}</td><td data-label="Tahun Ajaran">${s.TahunAjaran||''}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="_l('${s.NISN}')">Ubah</button><button class="c-btn c-btn-sm c-btn-d" onclick="_n('${s.NISN}')">Hapus</button></td>`,b.appendChild(r)})},_j=async()=>{const f=I('f_sw'),d=new FormData(f),o=I('f_n_o').value,a=o?'updateSiswa':'addSiswa';d.append('action',a),o&&d.append('oldNisn',o),_H(!0);try{const r=await fetch(_A,{method:'POST',body:d}),t=await r.json();'success'===t.status?(_I(t.message,'success'),_m(),_h(!0),_F=!1,_Y()):_I(`Gagal: ${t.message}`,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}},_l=n=>{const s=_B.find(i=>i.NISN==n);s&&(I('f_n').value=s.NISN,I('f_nm').value=s.Nama,I('f_kl').value=s.Kelas,I('f_ta').value=s.TahunAjaran,I('f_mpl').value=s.MataPelajaran||'',I('f_sms').value=s.Semester||'',I('f_n_o').value=s.NISN,I('sv_sw_btn').textContent='Update',I('f_sw').scrollIntoView({behavior:'smooth'}))},_m=()=>{I('f_sw').reset(),I('f_n_o').value='',I('sv_sw_btn').textContent='Simpan'},_n=async n=>{confirm(`Yakin hapus siswa NISN: ${n}?`)&&(_H(!0),f=new FormData,f.append('action','deleteSiswa'),f.append('nisn',n),async()=>{try{const r=await fetch(_A,{method:'POST',body:f}),t=await r.json();'success'===t.status?(_I(t.message,'success'),_h(!0),_F=!1,_Y()):_I(`Gagal: ${t.message}`,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}}())},_o=()=>{const t=document.querySelector("#s3 table");t&&t.rows.length>1?XLSX.writeFile(XLSX.utils.table_to_book(t,{sheet:"Daftar Siswa"}),"Daftar_Siswa.xlsx"):_I('Tidak ada data.','error')},_p=async()=>{const t=I('f_t').value,s=I('f_s').value,k=I('f_k').value,m=I('f_mp').value,b=I('p_tbl');if(!t||!s||!k||!m)return _I('Pilih semua filter dahulu.','info');_H(!0),b.innerHTML='<tr><td colspan="3">Memuat...</td></tr>';const p=new URLSearchParams({action:'getSiswaForPresensi',tahunAjaran:t,semester:s,kelas:k,mapel:m}).toString();try{const r=await fetch(`${_A}?${p}`),d=await r.json();b.innerHTML='','success'===d.status&&d.data.length>0?d.data.forEach(s=>{const e=document.createElement('tr');e.dataset.nisn=s.NISN,e.dataset.nama=s.Nama,e.innerHTML=`<td data-label="NISN">${s.NISN}</td><td data-label="Nama">${s.Nama}</td><td data-label="Kehadiran"><select class="k-stat" style="width:100%;padding:.5rem;"><option value="Hadir" selected>Hadir</option><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Alfa">Alfa</option></select></td>`,b.appendChild(e)}):b.innerHTML='<tr><td colspan="3" style="text-align:center;">Siswa tidak cocok.</td></tr>'}catch(e){_I('Gagal muat siswa: '+e.message,'error')}finally{_H(!1)}},_q=async()=>{const d={tahunAjaran:I('f_t').value,semester:I('f_s').value,kelas:I('f_k').value,mataPelajaran:I('f_mp').value,tanggal:I('f_d').value,periode:I('f_p').value,materi:I('f_m').value,catatan:I('f_c').value};for(const k in d)if(!d[k]&&k!=='catatan'&&k!=='periode')return _I(`Isi kolom "${k}"`,'error');const r=document.querySelectorAll('#p_tbl tr');if(r.length===0||r[0].cells.length<3)return _I('Muat data siswa dahulu.','error');const p=Array.from(r).map(e=>({nisn:e.dataset.nisn,nama:e.dataset.nama,status:e.querySelector('.k-stat').value})),j={detail:d,presensi:p};_H(!0);try{const t=await fetch(`${_A}?action=submitJurnal`,{method:'POST',mode:'cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(j)}),s=await t.json();'success'===s.status?(_I(s.message,'success'),I('f_j').reset(),I('p_tbl').innerHTML='',_Y()):_I(`Gagal: ${s.message}`,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}},_r=async()=>{const b=I('r_tbl'),e=I('e_r_btn');if(!b)return;const p=new URLSearchParams({action:'getJurnalHistory',tahunAjaran:I('r_f_t').value,semester:I('r_f_s').value,kelas:I('r_f_k').value,mapel:I('r_f_mp').value,tanggalMulai:I('r_f_d1').value,tanggalSelesai:I('r_f_d2').value}).toString();_H(!0),b.innerHTML='<tr><td colspan="7">Memuat...</td></tr>',e.style.display='none';try{const r=await fetch(`${_A}?${p}`),t=await r.json();'success'===t.status?(_C=t.data,_s(t.data),t.data.length>0&&(e.style.display='inline-block')):(_I('Gagal muat riwayat: '+t.message,'error'),b.innerHTML='<tr><td colspan="7" style="text-align:center;">Gagal muat.</td></tr>')}catch(err){_I('Error server: '+err.message,'error'),b.innerHTML='<tr><td colspan="7" style="text-align:center;">Error jaringan.</td></tr>'}finally{_H(!1)}},_s=a=>{const b=I('r_tbl');b.innerHTML='',a.length===0?b.innerHTML='<tr><td colspan="7" style="text-align:center;">Riwayat tidak ditemukan.</td></tr>':a.forEach(j=>{const r=document.createElement('tr');r.innerHTML=`<td data-label="Tanggal">${new Date(j.Tanggal).toLocaleDateString('id-ID')}</td><td data-label="Kelas">${j.Kelas}</td><td data-label="Semester">${j.Semester||'N/A'}</td><td data-label="Mapel">${j.MataPelajaran}</td><td data-label="Materi">${(j.Materi||'').substring(0,50)}...</td><td data-label="Kehadiran">${j.Kehadiran}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="_t('${j.ID}')">Detail</button></td>`,b.appendChild(r)})},_t=j=>{const d=_C.find(i=>i.ID==j);d?alert(`DETAIL\n---------------------------------\nTanggal: ${new Date(d.Tanggal).toLocaleDateString('id-ID')}\nKelas: ${d.Kelas}\nSemester: ${d.Semester||'N/A'}\nMapel: ${d.MataPelajaran}\nPeriode: ${d.Periode||'N/A'}\nKehadiran: ${d.Kehadiran}\n---------------------------------\nMateri:\n${d.Materi}\n\nCatatan:\n${d.Catatan||'Tidak ada.'}`):alert('Detail tidak ditemukan!')},_u=()=>{if(_C.length===0)return _I('Tidak ada data.','info');const d=_C.map(j=>({Tanggal:new Date(j.Tanggal).toLocaleDateString('id-ID'),"Tahun Ajaran":j.TahunAjaran,Semester:j.Semester,Kelas:j.Kelas,"Mata Pelajaran":j.MataPelajaran,Materi:j.Materi,Catatan:j.Catatan,Periode:j.Periode,Kehadiran:j.Kehadiran})),w=XLSX.utils.json_to_sheet(d),b=XLSX.utils.book_new();XLSX.utils.book_append_sheet(b,w,"Riwayat Jurnal"),XLSX.writeFile(b,`Riwayat_Jurnal_${new Date().toISOString().slice(0,10)}.xlsx`)},_v=async f=>{const b=I('pg_r_tbl');if(!b)return;if(!f&&_D.length>0)return _w(_D);_H(!0),b.innerHTML='<tr><td colspan="4">Memuat...</td></tr>';try{const r=await fetch(`${_A}?action=getUsers`),t=await r.json();'success'===t.status?(_D=t.data,_w(t.data)):b.innerHTML=`<tr><td colspan="4">Gagal: ${t.message}</td></tr>`}catch(e){_I('Gagal muat user.','error'),b.innerHTML='<tr><td colspan="4">Gagal terhubung.</td></tr>'}finally{_H(!1)}},_w=a=>{const b=I('pg_r_tbl');b.innerHTML='',a.length===0?b.innerHTML='<tr><td colspan="4" style="text-align:center;">User tidak ada.</td></tr>':a.forEach(u=>{const r=document.createElement('tr');r.innerHTML=`<td data-label="Nama Lengkap">${u.nama}</td><td data-label="Username">${u.username}</td><td data-label="Peran">${u.peran}</td><td data-label="Aksi"><button class="c-btn c-btn-sm c-btn-s" onclick="_y('${u.username}')">Ubah</button><button class="c-btn c-btn-sm c-btn-d" onclick="_z('${u.username}')">Hapus</button></td>`,b.appendChild(r)})},_x=async()=>{const o=I('f_u_o').value,a=o?'updateUser':'addUser',f=new FormData;f.append('action',a),f.append('nama',I('f_p_nm').value),f.append('username',I('f_u').value),f.append('password',I('f_pw').value),f.append('peran',I('f_r').value),o&&f.append('oldUsername',o);if(a==='addUser'&&!f.get('password'))return _I('Password wajib.','error');_H(!0);try{const r=await fetch(_A,{method:'POST',body:f}),t=await r.json();'success'===t.status?(_I(t.message,'success'),_A_(),_v(!0)):_I(`Gagal: ${t.message}`,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}},_y=u=>{const d=_D.find(i=>i.username===u);d&&(I('f_u_o').value=d.username,I('f_p_nm').value=d.nama,I('f_u').value=d.username,I('f_r').value=d.peran,I('f_pw').value='',I('f_pw').placeholder='Kosongkan jika tidak diubah',I('sv_pg_btn').textContent='Update User',I('f_pg').scrollIntoView({behavior:'smooth'}))},_z=async u=>{const l=JSON.parse(sessionStorage.getItem('loggedInUser'));if(l&&l.username===u)return _I('Tidak bisa hapus akun sendiri.','error');confirm(`Yakin hapus user '${u}'?`)&&(_H(!0),f=new FormData,f.append('action','deleteUser'),f.append('username',u),async()=>{try{const r=await fetch(_A,{method:'POST',body:f}),t=await r.json();'success'===t.status?(_I(t.message,'success'),_v(!0)):_I(`Gagal: ${t.message}`,'error')}catch(e){_I(`Error: ${e.message}`,'error')}finally{_H(!1)}}())},_A_=()=>{I('f_pg').reset(),I('f_u_o').value='',I('sv_pg_btn').textContent='Simpan User',I('f_pw').placeholder='Isi password baru'};const _B_=()=>{I('l_btn')?.addEventListener('click',_P);const n=document.querySelectorAll('.s-nav button');n.forEach(b=>{b.addEventListener('click',()=>{n.forEach(t=>t.classList.remove('active')),b.classList.add('active');const s=b.dataset.s;_K(s),'s2'===s?(_Z(),_r()):'s4'===s?_v(!0):'s1'===s?_g():'s3'===s&&_h()})}),I('f_t')?.addEventListener('change',_a),I('f_s')?.addEventListener('change',_b),I('f_k')?.addEventListener('change',_c),I('r_f_t')?.addEventListener('change',_d),I('r_f_s')?.addEventListener('change',_e),I('r_f_k')?.addEventListener('change',_f),I('ld_s_btn')?.addEventListener('click',_p),I('s_j_btn')?.addEventListener('click',_q),I('f_r_btn')?.addEventListener('click',_r),I('e_r_btn')?.addEventListener('click',_u),I('f_sw')?.addEventListener('submit',e=>{e.preventDefault(),_j()}),I('rst_sw_btn')?.addEventListener('click',_m),I('sr_btn')?.addEventListener('click',()=>_h(!0)),I('ex_sw_btn')?.addEventListener('click',_o),I('sr_in')?.addEventListener('keyup',e=>{clearTimeout(_G),e.key==='Enter'?_h(!0):_G=setTimeout(()=>_h(!0),400)}),I('f_pg')?.addEventListener('submit',e=>{e.preventDefault(),_x()}),I('rst_pg_btn')?.addEventListener('click',_A_)},_C_=async()=>{_N(),_B_(),await _Y(),_K('s1');const d=document.querySelector('.s-nav button[data-s="s1"]');d&&(d.classList.add('active'),_g())},_D_=()=>{_N(),I('lb')?.addEventListener('click',_O),document.querySelector('.c1 form, .c2a form')?.addEventListener('submit',e=>{e.preventDefault(),_O()}),_L()};document.addEventListener('DOMContentLoaded',()=>{const d=window.location.pathname.includes('dashboard.html');d?sessionStorage.getItem('loggedInUser')?_C_():window.location.href='index.html':_D_()});
